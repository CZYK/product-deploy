/*
 * Initial Site.db execution scripts. Builds the tables.
 *
 * <p>The contents of this file are executed every time you deploy.</p>
 *
 * @copyright Â© 2017 StudyPortals B.V., all rights reserved
 */

CREATE TABLE `cms_sites` (
	`id` INTEGER PRIMARY KEY,
	`name` TEXT NOT NULL
);

CREATE TABLE `cms_redirects` (
	`id` INTEGER PRIMARY KEY AUTOINCREMENT,
	`site_id` INTEGER NOT NULL,
	`page_id` INTEGER DEFAULT NULL,
	`path` TEXT NOT NULL,
	`url`TEXT DEFAULT NULL,
	`type` INTEGER NOT NULL,
	UNIQUE (`site_id`, `path`),
	FOREIGN KEY(`site_id`) REFERENCES cms_sites(`id`),
	FOREIGN KEY(`page_id`) REFERENCES cms_pages(`id`)
);

CREATE TABLE `cms_pages_languages` (
	`id` INTEGER PRIMARY KEY,
	`page_id` INTEGER NOT NULL,
	`language_id` INTEGER NOT NULL,
	`title` TEXT NOT NULL,
	`subtitle` TEXT DEFAULT NULL,
	`description` TEXT NOT NULL,
	FOREIGN KEY(`page_id`) REFERENCES cms_pages(`id`),
	FOREIGN KEY(`language_id`) REFERENCES cms_languages(`id`)
);

CREATE TABLE `cms_pages` (
	`id` INTEGER PRIMARY KEY,
	`site_id` INTEGER NOT NULL,
	`parent_id` INTEGER DEFAULT NULL,
	`template` TEXT NOT NULL,
	`name` TEXT NOT NULL,
	`page_order` INTEGER NOT NULL DEFAULT 1,
	`disabled` INTEGER NOT NULL DEFAULT 0,
	`hidden` INTEGER NOT NULL DEFAULT 0,
	UNIQUE (`parent_id`, `name`),
	FOREIGN KEY(`site_id`) REFERENCES cms_sites(`id`),
	FOREIGN KEY(`parent_id`) REFERENCES cms_pages(`id`)
);

CREATE TABLE "cms_modules" (
	`id`	INTEGER DEFAULT 0,
	`page_id`	INTEGER NOT NULL ,
	`language_id`	INTEGER DEFAULT 1,
	`pane`	TEXT NOT NULL,
	`definition`	TEXT DEFAULT NULL,
	`settings`	TEXT DEFAULT NULL,
	`settings_json`	TEXT DEFAULT NULL,
	`class`	TEXT DEFAULT NULL,
	PRIMARY KEY(page_id, pane, definition, class),
	FOREIGN KEY(`page_id`) REFERENCES cms_pages ( `id` ),
	FOREIGN KEY(`language_id`) REFERENCES cms_languages ( `id` )
);

CREATE TRIGGER `set_module_id`
	AFTER INSERT ON `cms_modules`
	FOR EACH ROW
BEGIN
	Update cms_modules
	set id = (
		select ifnull(max(id), 0) + 1
		from cms_modules)
	where id is null;
END;

CREATE TABLE `cms_languages` (
	`id` INTEGER PRIMARY KEY,
	`locale` TEXT NOT NULL,
	`name` TEXT NOT NULL,
	UNIQUE (`locale`)
);

INSERT INTO `cms_languages` VALUES (1,'en-GB','English');
INSERT INTO `cms_languages` VALUES (2,'fr-FR','Francais');
INSERT INTO `cms_languages` VALUES (3,'de-DE','Deutsch');
INSERT INTO `cms_languages` VALUES (4,'es-ES','Espanol');